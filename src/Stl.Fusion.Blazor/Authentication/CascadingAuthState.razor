@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@using Stl.Async
@using Stl.Fusion.Authentication
@using Stl.Fusion.Blazor.Internal
@using Stl.OS
@using Stl.Text
@implements IDisposable
@inject ISessionProvider _sessionProvider
@inject AuthStateProvider _authStateProvider
@inject PresenceService _presenceService
@inject NavigationManager _nav
@inject IJSRuntime _js

<CascadingAuthenticationState>
    <CascadingValue TValue="Task<AuthState>" Value="@GetAuthState()" ChildContent="@ChildContent"/>
</CascadingAuthenticationState>

@code {
    [Parameter]
    public RenderFragment ChildContent { get; set; } = _ => { };
    [Parameter]
    public string SessionId {
        get => _sessionProvider.HasSession ? _sessionProvider.Session.Id : "";
        set {
            if (string.IsNullOrEmpty(value))
                return; // Blazor WASM component is created w/ empty SessionId
            if (_sessionProvider.HasSession)
                return;
            _sessionProvider.Session = new Session(value);
        }
    }
    [Parameter]
    public bool StartPresenceService { get; set; } = true;

    protected override void OnInitialized()
    {
        if (SessionId.IsNullOrEmpty())
            throw Errors.NoSessionId();

        _authStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        OnAuthenticationStateChanged(_authStateProvider.GetAuthenticationStateAsync());
        if (StartPresenceService)
            _presenceService.Start();
    }

    void IDisposable.Dispose()
        => _authStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;


    private void OnAuthenticationStateChanged(Task<AuthenticationState> newAuthStateTask)
    {
        _ = newAuthStateTask.ContinueWith(t => {
            if (!t.IsCompletedSuccessfully)
                return; // Will react to the next change
            var authState = (AuthState) t.Result;
            if (!authState.IsSignOutForced)
                return;
            // Current Session is unusable due to forced sign-out.
            // The only way to get an usable one is to reload the page.
            _ = InvokeAsync(() => _nav.NavigateTo(_nav.Uri, true));
        }, TaskScheduler.Current);
    }

    private Task<AuthState> GetAuthState()
        => _authStateProvider.GetAuthenticationStateAsync()
            .ContinueWith(t => (AuthState) t.Result, TaskScheduler.Current);
}
